{%- macro add_comments() -%}

{% set giscus_enabled = config.extra.giscus.enabled_for_all_posts or page.extra.giscus %}
{% set utterances_enabled = config.extra.utterances.enabled_for_all_posts or page.extra.utterances %}

{# Ensure only one comment system is enabled #}
{% if giscus_enabled and utterances_enabled %}
    {{ throw(message="ERROR: Multiple comment systems have been enabled for the same page. Check your config.toml and individual page settings to ensure only one comment system is activated at a time.") }}

{% elif giscus_enabled %}
    {# Create a div to host giscus comments #}
    <div class="comments" 
        {# Store required giscus data attributes in the div #}
        data-repo="{{ config.extra.giscus.repo }}"
        data-repo-id="{{ config.extra.giscus.repo_id }}"
        data-category="{{ config.extra.giscus.category }}"
        data-category-id="{{ config.extra.giscus.category_id }}"
        {% if config.extra.giscus.mapping == "slug" %}
            data-mapping="specific"
            data-term="{{ page.slug }}"
        {% else %}
            data-mapping="{{ config.extra.giscus.mapping }}"
        {% endif %}
        data-strict="{{ config.extra.giscus.strict_title_matching }}"
        data-reactions-enabled="{{ config.extra.giscus.enable_reactions }}"
        {% if config.extra.giscus.comment_box_above_comments %}
            data-input-position="top"
        {% else %}
            data-input-position="bottom"
        {% endif %}
        data-light-theme="{{ config.extra.giscus.light_theme }}"
        data-dark-theme="{{ config.extra.giscus.dark_theme }}"
        {% if config.extra.giscus.lang  %}
            data-lang="{{ config.extra.giscus.lang }}"
        {% else %}
            data-lang="{{ lang }}"
        {% endif %}
        data-lazy-loading="{{ config.extra.giscus.lazy_loading | default(value=true) }}">
    </div>

    {# giscus script to load the widget #}
    <script src="{{ get_url(path='js/giscus_min.js', trailing_slash=false) | safe }}"/></script>

{% elif utterances_enabled %}
    {# Create a div to host utterances comments #}
    <div class="comments" 
        {# Store required utterances data attributes in the div #}
        data-repo="{{ config.extra.utterances.repo }}"
        {% if config.extra.utterances.issue_term == "slug" %}
            data-issue-term="{{ page.slug }}"
        {% else %}
            data-issue-term="{{ config.extra.utterances.issue_term }}"
        {% endif %}
        data-label="{{ config.extra.utterances.label }}"
        data-light-theme="{{ config.extra.utterances.light_theme }}"
        data-dark-theme="{{ config.extra.utterances.dark_theme }}"
        data-lazy-loading="{{ config.extra.utterances.lazy_loading | default(value=true) }}">
    </div>

    {# utterances script to load the widget #}
    <script src="{{ get_url(path='js/utterances_min.js', trailing_slash=false) | safe }}"/></script>
{% endif %}

{%- endmacro add_comments -%}
